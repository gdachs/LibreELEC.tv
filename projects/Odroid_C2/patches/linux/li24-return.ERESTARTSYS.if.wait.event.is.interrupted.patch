From 17bdc68e2da6cf518cb2f6998a2f33e51ca56cd9 Mon Sep 17 00:00:00 2001
From: Radostan Riedel <raybuntu@googlemail.com>
Date: Tue, 28 Jun 2016 14:31:31 +0200
Subject: [PATCH] [aocec] return ERESTARTSYS if wait event is interrupted

---
 drivers/amlogic/cec/hdmi_ao_cec.c | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/drivers/amlogic/cec/hdmi_ao_cec.c b/drivers/amlogic/cec/hdmi_ao_cec.c
index ba457e8..138ec98 100644
--- a/drivers/amlogic/cec/hdmi_ao_cec.c
+++ b/drivers/amlogic/cec/hdmi_ao_cec.c
@@ -987,6 +987,14 @@ int cec_node_init(struct hdmitx_dev *hdmitx_device)
         (hdmitx_device->hpd_state == 0)) {
         return -1;
     }
+
+    if (wait_event_interruptible(hdmitx_device->hdmi_info.vsdb_phy_addr.waitq,
+            hdmitx_device->hdmi_info.vsdb_phy_addr.valid == 1))
+    {
+        CEC_INFO("error during wait for a valid physical address\n");
+        return -ERESTARTSYS;
+    }
+
     a = hdmitx_device->hdmi_info.vsdb_phy_addr.a;
     b = hdmitx_device->hdmi_info.vsdb_phy_addr.b;
     c = hdmitx_device->hdmi_info.vsdb_phy_addr.c;
@@ -1452,8 +1460,12 @@ static struct class_attribute aocec_class_attr[] = {
 /******************** cec hal interface ***************************/
 static int hdmitx_cec_open(struct inode *inode, struct file *file)
 {
-    wait_event_interruptible(cec_dev->tx_dev->hdmi_info.vsdb_phy_addr.waitq,
-            cec_dev->tx_dev->hdmi_info.vsdb_phy_addr.valid == 1);
+    if (wait_event_interruptible(cec_dev->tx_dev->hdmi_info.vsdb_phy_addr.waitq,
+            cec_dev->tx_dev->hdmi_info.vsdb_phy_addr.valid == 1))
+    {
+        CEC_INFO("error during wait for a valid physical address\n");
+        return -ERESTARTSYS;
+    }
     cec_dev->cec_info.open_count++;
     if (cec_dev->cec_info.open_count) {
         cec_dev->cec_info.hal_ctl = 1;
